<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#00355c">
<title>MVV Abfahrt</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
  :root {
    --mvv-dark: #00355c;
    --mvv-green: #c0d101;
    --mvv-white: #ffffff;
    --sbahn-green: #4CAF50;
    --ubahn-blue: #1565C0;
    --bus-purple: #9C27B0;
    --tram-red: #E53935;
    --bg: #f5f7fa;
    --card-bg: #ffffff;
    --text: #1a1a1a;
    --text-muted: #6b7280;
    --border: #e5e7eb;
    --delay-red: #dc2626;
    --on-time: #16a34a;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #0f1117;
      --card-bg: #1a1d27;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --border: #2d3040;
    }
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    -webkit-tap-highlight-color: transparent;
  }

  /* Header */
  .header {
    background: var(--mvv-dark);
    padding: 12px 16px;
    padding-top: max(12px, env(safe-area-inset-top));
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,.2);
  }

  .header-top {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }

  .header h1 {
    color: var(--mvv-green);
    font-size: 20px;
    font-weight: 700;
    flex: 1;
  }

  .header h1 span {
    color: var(--mvv-white);
    font-weight: 400;
    font-size: 14px;
    margin-left: 6px;
  }

  /* Search */
  .search-wrap {
    position: relative;
  }

  .search-input {
    width: 100%;
    padding: 10px 40px 10px 14px;
    border: 2px solid rgba(255,255,255,.15);
    border-radius: 10px;
    background: rgba(255,255,255,.1);
    color: white;
    font-size: 16px;
    outline: none;
    transition: border-color .2s;
  }

  .search-input::placeholder { color: rgba(255,255,255,.5); }
  .search-input:focus { border-color: var(--mvv-green); }

  .search-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(255,255,255,.5);
    pointer-events: none;
  }

  .search-clear {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: rgba(255,255,255,.5);
    font-size: 18px;
    cursor: pointer;
    display: none;
    padding: 4px;
  }

  /* Autocomplete */
  .autocomplete {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: var(--card-bg);
    border-radius: 10px;
    box-shadow: 0 8px 30px rgba(0,0,0,.3);
    overflow: hidden;
    display: none;
    z-index: 200;
    max-height: 300px;
    overflow-y: auto;
  }

  .autocomplete.show { display: block; }

  .ac-item {
    padding: 12px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background .15s;
  }

  .ac-item:active { background: rgba(0,53,92,.1); }

  .ac-type {
    font-size: 10px;
    text-transform: uppercase;
    font-weight: 600;
    color: var(--text-muted);
    min-width: 32px;
  }

  .ac-name { font-size: 15px; }

  /* Favorites */
  .favorites {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    overflow-x: auto;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
  }
  .favorites::-webkit-scrollbar { display: none; }

  .fav-chip {
    flex-shrink: 0;
    padding: 8px 14px;
    border-radius: 20px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all .2s;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }

  .fav-chip.active {
    background: var(--mvv-dark);
    color: white;
    border-color: var(--mvv-dark);
  }

  .fav-chip .fav-remove {
    font-size: 14px;
    opacity: .5;
    margin-left: 2px;
  }

  /* Content */
  .content {
    padding: 0 12px 80px;
  }

  /* Station Header */
  .station-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 4px 8px;
  }

  .station-name {
    font-size: 17px;
    font-weight: 600;
  }

  .station-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .btn-icon {
    background: none;
    border: none;
    font-size: 22px;
    cursor: pointer;
    padding: 4px;
    opacity: .6;
    transition: opacity .2s;
  }
  .btn-icon:active { opacity: 1; }

  .last-update {
    font-size: 11px;
    color: var(--text-muted);
    padding: 0 4px 6px;
  }

  /* Departure List */
  .dep-list {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .dep-item {
    display: grid;
    grid-template-columns: 56px 1fr auto;
    gap: 10px;
    align-items: center;
    padding: 10px 12px;
    background: var(--card-bg);
    border-radius: 10px;
    min-height: 52px;
    transition: transform .15s;
  }

  .dep-item:first-child { border-radius: 10px 10px 4px 4px; }
  .dep-item:last-child { border-radius: 4px 4px 10px 10px; }
  .dep-item:only-child { border-radius: 10px; }

  .dep-line {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .dep-line img {
    height: 24px;
    width: auto;
  }

  .line-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 700;
    color: white;
    min-width: 44px;
    text-align: center;
  }

  .line-sbahn { background: var(--sbahn-green); }
  .line-ubahn { background: var(--ubahn-blue); }
  .line-bus { background: #9C27B0; }
  .line-tram { background: #E53935; }
  .line-regio { background: #616161; }

  .dep-info {
    min-width: 0;
  }

  .dep-direction {
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .dep-track {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 1px;
  }

  .dep-time {
    text-align: right;
    white-space: nowrap;
  }

  .dep-time-main {
    font-size: 18px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
  }

  .dep-time-min {
    font-size: 13px;
    font-weight: 600;
    display: block;
    margin-top: -1px;
  }

  .on-time { color: var(--on-time); }
  .delayed { color: var(--delay-red); }

  .dep-time-planned {
    font-size: 11px;
    color: var(--text-muted);
    text-decoration: line-through;
  }

  /* Notification banner */
  .notif-banner {
    margin: 8px 0;
    padding: 10px 14px;
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    border-radius: 0 8px 8px 0;
    font-size: 13px;
    line-height: 1.4;
    color: #92400e;
    cursor: pointer;
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  @media (prefers-color-scheme: dark) {
    .notif-banner {
      background: #422006;
      color: #fde68a;
    }
  }

  .notif-icon { flex-shrink: 0; font-size: 16px; }
  .notif-text { flex: 1; }
  .notif-text.collapsed {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .empty-state .icon {
    font-size: 48px;
    margin-bottom: 12px;
  }

  .empty-state h2 {
    font-size: 18px;
    margin-bottom: 6px;
    color: var(--text);
  }

  .empty-state p {
    font-size: 14px;
    line-height: 1.5;
  }

  /* Loading */
  .loading-bar {
    height: 3px;
    background: var(--mvv-green);
    position: fixed;
    top: 0;
    left: 0;
    z-index: 999;
    transition: width .3s;
    border-radius: 0 2px 2px 0;
  }

  .spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--mvv-green);
    border-radius: 50%;
    animation: spin .8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Filter tabs */
  .filter-tabs {
    display: flex;
    gap: 6px;
    padding: 4px 4px 8px;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .filter-tabs::-webkit-scrollbar { display: none; }

  .filter-tab {
    flex-shrink: 0;
    padding: 5px 12px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--card-bg);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all .2s;
  }

  .filter-tab.active {
    background: var(--mvv-dark);
    color: white;
    border-color: var(--mvv-dark);
  }

  /* Pull to refresh indicator */
  .pull-indicator {
    text-align: center;
    padding: 8px;
    font-size: 12px;
    color: var(--text-muted);
    display: none;
  }

  /* Footer hint */
  .footer-hint {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--mvv-dark);
    color: rgba(255,255,255,.6);
    text-align: center;
    font-size: 10px;
    padding: 6px;
    padding-bottom: max(6px, env(safe-area-inset-bottom));
  }

  .footer-hint a { color: var(--mvv-green); text-decoration: none; }
</style>
</head>
<body>

<div class="loading-bar" id="loadingBar" style="width:0%"></div>

<div class="header">
  <div class="header-top">
    <h1>üöá MVV<span>Abfahrt</span></h1>
  </div>
  <div class="search-wrap">
    <input type="text" class="search-input" id="searchInput"
           placeholder="Haltestelle suchen..." autocomplete="off" autocorrect="off">
    <span class="search-icon" id="searchIcon">üîç</span>
    <button class="search-clear" id="searchClear" onclick="clearSearch()">‚úï</button>
    <div class="autocomplete" id="autocomplete"></div>
  </div>
</div>

<div class="favorites" id="favorites"></div>

<div class="content" id="content">
  <div class="empty-state" id="emptyState">
    <div class="icon">üöâ</div>
    <h2>Willkommen!</h2>
    <p>Suche eine Haltestelle, um die<br>n√§chsten Abfahrten zu sehen.</p>
  </div>
  <div id="departures" style="display:none">
    <div class="station-header">
      <div class="station-name" id="stationName"></div>
      <div class="station-actions">
        <button class="btn-icon" id="btnFav" onclick="toggleFavorite()" title="Favorit">‚òÜ</button>
        <button class="btn-icon" onclick="loadDepartures()" title="Aktualisieren">üîÑ</button>
      </div>
    </div>
    <div class="last-update" id="lastUpdate"></div>
    <div class="filter-tabs" id="filterTabs"></div>
    <div id="notifications"></div>
    <div class="dep-list" id="depList"></div>
  </div>
</div>

<div class="footer-hint">
  Daten: <a href="https://www.mvv-muenchen.de" target="_blank">MVV M√ºnchen</a> ¬∑ Auto-Refresh alle 30s
</div>

<script>
const API = 'https://www.mvv-muenchen.de';
const ICON_BASE = 'https://www.mvv-muenchen.de/fileadmin/lines/';

let currentStop = null;   // { id, name }
let departures = [];
let activeFilter = 'all';
let refreshTimer = null;
let searchTimer = null;

// --- Favorites ---
function getFavorites() {
  try { return JSON.parse(localStorage.getItem('mvv-favs') || '[]'); }
  catch { return []; }
}

function saveFavorites(favs) {
  localStorage.setItem('mvv-favs', JSON.stringify(favs));
  renderFavorites();
}

function toggleFavorite() {
  if (!currentStop) return;
  let favs = getFavorites();
  const idx = favs.findIndex(f => f.id === currentStop.id);
  if (idx >= 0) {
    favs.splice(idx, 1);
  } else {
    favs.push({ id: currentStop.id, name: currentStop.name });
  }
  saveFavorites(favs);
  updateFavButton();
}

function updateFavButton() {
  const btn = document.getElementById('btnFav');
  if (!currentStop) return;
  const isFav = getFavorites().some(f => f.id === currentStop.id);
  btn.textContent = isFav ? '‚òÖ' : '‚òÜ';
  btn.style.opacity = isFav ? '1' : '.6';
  btn.style.color = isFav ? '#f59e0b' : '';
}

function renderFavorites() {
  const container = document.getElementById('favorites');
  const favs = getFavorites();
  if (!favs.length) {
    container.style.display = 'none';
    return;
  }
  container.style.display = 'flex';
  container.innerHTML = favs.map(f => `
    <div class="fav-chip ${currentStop && currentStop.id === f.id ? 'active' : ''}"
         onclick="selectStop('${f.id}', '${f.name.replace(/'/g, "\\'")}')">
      ${shortName(f.name)}
    </div>
  `).join('');
}

function shortName(name) {
  // "M√ºnchen, Marienplatz" ‚Üí "Marienplatz"
  const parts = name.split(', ');
  return parts.length > 1 ? parts.slice(1).join(', ') : name;
}

// --- Search ---
document.getElementById('searchInput').addEventListener('input', function(e) {
  const q = e.target.value.trim();
  const clear = document.getElementById('searchClear');
  const icon = document.getElementById('searchIcon');

  if (q.length > 0) {
    clear.style.display = 'block';
    icon.style.display = 'none';
  } else {
    clear.style.display = 'none';
    icon.style.display = 'block';
    hideAutocomplete();
    return;
  }

  if (q.length < 2) return;

  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => searchStops(q), 250);
});

document.getElementById('searchInput').addEventListener('focus', function() {
  const q = this.value.trim();
  if (q.length >= 2) searchStops(q);
});

document.addEventListener('click', function(e) {
  if (!e.target.closest('.search-wrap')) hideAutocomplete();
});

async function searchStops(query) {
  try {
    const res = await fetch(`${API}/?eID=stopFinder&query=${encodeURIComponent(query)}`);
    const data = await res.json();
    if (data.success && data.results) {
      showAutocomplete(data.results.filter(r => r.anyType === 'stop').slice(0, 8));
    }
  } catch (err) {
    console.error('Search error:', err);
  }
}

function showAutocomplete(results) {
  const ac = document.getElementById('autocomplete');
  if (!results.length) {
    ac.innerHTML = '<div class="ac-item"><span style="color:var(--text-muted)">Keine Haltestellen gefunden</span></div>';
    ac.classList.add('show');
    return;
  }
  ac.innerHTML = results.map(r => `
    <div class="ac-item" onclick="selectStop('${r.id}', '${r.name.replace(/'/g, "\\'")}')">
      <span class="ac-type">${typeIcon(r.anyType)}</span>
      <span class="ac-name">${r.name}</span>
    </div>
  `).join('');
  ac.classList.add('show');
}

function hideAutocomplete() {
  document.getElementById('autocomplete').classList.remove('show');
}

function clearSearch() {
  const input = document.getElementById('searchInput');
  input.value = '';
  document.getElementById('searchClear').style.display = 'none';
  document.getElementById('searchIcon').style.display = 'block';
  hideAutocomplete();
  input.focus();
}

function typeIcon(type) {
  switch (type) {
    case 'stop': return 'üöè';
    case 'poi': return 'üìç';
    case 'street': return 'üõ£Ô∏è';
    default: return 'üìå';
  }
}

// --- Select & Load ---
function selectStop(id, name) {
  currentStop = { id, name };
  hideAutocomplete();
  document.getElementById('searchInput').value = '';
  document.getElementById('searchClear').style.display = 'none';
  document.getElementById('searchIcon').style.display = 'block';
  document.getElementById('searchInput').blur();

  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('departures').style.display = 'block';
  document.getElementById('stationName').textContent = currentStop.name;

  activeFilter = 'all';
  updateFavButton();
  renderFavorites();
  loadDepartures();

  // Save last station
  localStorage.setItem('mvv-last', JSON.stringify(currentStop));
}

async function loadDepartures() {
  if (!currentStop) return;

  showLoading();
  try {
    const ts = Math.floor(Date.now() / 1000);
    const res = await fetch(
      `${API}/?eID=departuresFinder&action=get_departures&stop_id=${encodeURIComponent(currentStop.id)}&requested_timestamp=${ts}&lines=`
    );
    const data = await res.json();

    if (data.error) {
      console.warn('API error:', data.error);
    }

    departures = data.departures || [];
    renderDepartures();
    renderNotifications(data.departures || []);
    renderFilterTabs();

    const now = new Date();
    document.getElementById('lastUpdate').textContent =
      `Aktualisiert ${now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}`;

  } catch (err) {
    console.error('Load error:', err);
    document.getElementById('depList').innerHTML =
      '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Fehler beim Laden</p></div>';
  }
  hideLoading();
  scheduleRefresh();
}

function scheduleRefresh() {
  clearTimeout(refreshTimer);
  refreshTimer = setTimeout(() => loadDepartures(), 30000);
}

// --- Render Departures ---
function renderDepartures() {
  const list = document.getElementById('depList');
  let filtered = departures;

  if (activeFilter !== 'all') {
    filtered = departures.filter(d => classifyLine(d.line.name) === activeFilter);
  }

  if (!filtered.length) {
    list.innerHTML = '<div class="empty-state" style="padding:30px"><p>Keine Abfahrten gefunden</p></div>';
    return;
  }

  const now = new Date();

  list.innerHTML = filtered.map(d => {
    const lineClass = lineColorClass(d.line.name);
    const hasIcon = d.line.symbol && d.line.symbol.endsWith('.svg');
    const lineHtml = hasIcon
      ? `<img src="${ICON_BASE}${d.line.symbol}" alt="${d.line.number}" onerror="this.outerHTML='<span class=\\'line-badge ${lineClass}\\'>${d.line.number}</span>'">`
      : `<span class="line-badge ${lineClass}">${d.line.number}</span>`;

    const planned = d.departurePlanned;
    const live = d.departureLive || planned;
    const isDelayed = !d.inTime && live !== planned;

    // Calculate minutes until departure
    const [lh, lm] = live.split(':').map(Number);
    const depDate = parseDepDate(d.departureDate, lh, lm);
    const diffMs = depDate - now;
    const diffMin = Math.round(diffMs / 60000);

    let minText = '';
    let minClass = '';
    if (diffMin <= 0) {
      minText = 'jetzt';
      minClass = 'on-time';
    } else if (diffMin <= 60) {
      minText = `${diffMin} min`;
      minClass = isDelayed ? 'delayed' : 'on-time';
    }

    const trackText = d.track ? d.track.replace('U-Bahn ', '') : '';

    return `
      <div class="dep-item">
        <div class="dep-line">${lineHtml}</div>
        <div class="dep-info">
          <div class="dep-direction">${d.direction}</div>
          ${trackText ? `<div class="dep-track">${trackText}</div>` : ''}
        </div>
        <div class="dep-time">
          <span class="dep-time-main ${isDelayed ? 'delayed' : ''}">${live}</span>
          ${isDelayed ? `<span class="dep-time-planned">${planned}</span>` : ''}
          <span class="dep-time-min ${minClass}">${minText}</span>
        </div>
      </div>
    `;
  }).join('');
}

function parseDepDate(dateStr, h, m) {
  // dateStr = "20260207"
  const y = parseInt(dateStr.substring(0, 4));
  const mo = parseInt(dateStr.substring(4, 6)) - 1;
  const da = parseInt(dateStr.substring(6, 8));
  return new Date(y, mo, da, h, m, 0);
}

function classifyLine(name) {
  const n = name.toLowerCase();
  if (n.includes('s-bahn')) return 'sbahn';
  if (n.includes('u-bahn')) return 'ubahn';
  if (n.includes('bus')) return 'bus';
  if (n.includes('tram') || n.includes('stra√üenbahn')) return 'tram';
  return 'other';
}

function lineColorClass(name) {
  switch (classifyLine(name)) {
    case 'sbahn': return 'line-sbahn';
    case 'ubahn': return 'line-ubahn';
    case 'bus': return 'line-bus';
    case 'tram': return 'line-tram';
    default: return 'line-regio';
  }
}

// --- Filter Tabs ---
function renderFilterTabs() {
  const types = new Set(departures.map(d => classifyLine(d.line.name)));
  const container = document.getElementById('filterTabs');

  if (types.size <= 1) {
    container.style.display = 'none';
    return;
  }
  container.style.display = 'flex';

  const labels = {
    all: 'Alle',
    sbahn: 'üü¢ S-Bahn',
    ubahn: 'üîµ U-Bahn',
    bus: 'üü£ Bus',
    tram: 'üî¥ Tram',
    other: 'Sonstige'
  };

  let tabs = `<div class="filter-tab ${activeFilter === 'all' ? 'active' : ''}" onclick="setFilter('all')">Alle</div>`;
  for (const t of ['sbahn', 'ubahn', 'tram', 'bus', 'other']) {
    if (types.has(t)) {
      tabs += `<div class="filter-tab ${activeFilter === t ? 'active' : ''}" onclick="setFilter('${t}')">${labels[t]}</div>`;
    }
  }
  container.innerHTML = tabs;
}

function setFilter(f) {
  activeFilter = f;
  renderDepartures();
  renderFilterTabs();
}

// --- Notifications ---
function renderNotifications(deps) {
  const container = document.getElementById('notifications');
  const seen = new Set();
  const notifs = [];

  for (const d of deps) {
    for (const n of (d.notifications || [])) {
      const key = n.text.substring(0, 60);
      if (!seen.has(key)) {
        seen.add(key);
        notifs.push(n);
      }
    }
  }

  if (!notifs.length) {
    container.innerHTML = '';
    return;
  }

  container.innerHTML = notifs.slice(0, 3).map((n, i) => `
    <div class="notif-banner" onclick="this.querySelector('.notif-text').classList.toggle('collapsed')">
      <span class="notif-icon">‚ö†Ô∏è</span>
      <span class="notif-text collapsed">${n.text}</span>
    </div>
  `).join('');
}

// --- Loading ---
function showLoading() {
  const bar = document.getElementById('loadingBar');
  bar.style.width = '70%';
}

function hideLoading() {
  const bar = document.getElementById('loadingBar');
  bar.style.width = '100%';
  setTimeout(() => {
    bar.style.transition = 'none';
    bar.style.width = '0%';
    setTimeout(() => bar.style.transition = 'width .3s', 50);
  }, 300);
}

// --- Init ---
function init() {
  // Pre-seed favorites on first visit
  if (!localStorage.getItem('mvv-favs')) {
    saveFavorites([
      { id: 'de:09162:1730', name: 'M√ºnchen, Neuaubing' },
      { id: 'de:09162:8', name: 'M√ºnchen, Donnersbergerbr√ºcke' }
    ]);
  }

  renderFavorites();

  // Restore last station or load first favorite
  try {
    const last = JSON.parse(localStorage.getItem('mvv-last'));
    if (last && last.id) {
      selectStop(last.id, last.name);
    } else {
      const favs = getFavorites();
      if (favs.length) selectStop(favs[0].id, favs[0].name);
    }
  } catch {}

  // Keyboard: Enter to search
  document.getElementById('searchInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      const first = document.querySelector('.ac-item');
      if (first) first.click();
    }
  });

  // Visibility change: refresh when coming back
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden && currentStop) {
      loadDepartures();
    }
  });
}

init();

// Register Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>
</body>
</html>
